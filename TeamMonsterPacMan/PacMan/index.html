<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Pac Man</title>
    <link href="styles/styles.css" rel="stylesheet" />
</head>
<body>
    <div id="canvas-container"></div>
    <script src="scripts/raphael-min.js"></script>
    <script src="scripts/kinetic.min.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/game-objects.js"></script>
    <script src="js/levels.js"></script>
    <script src="js/menu.js"></script>
    <script>
        // Set paper for drawing with rendered
        var paper = Raphael(0, 0, 560, 560);
        var paperPacMan = Raphael(0, 0, 560, 560);

        // TESTS
        var dots = [];
        var level = level1(makeMatrix(28, 28, 20));

        var obj = new Ghost(new Position(140, 160), 'ghost', 'left', 1);
        var engine = new Engine(paper);
        var player = new PacMan(new Position(20, 20), 'player', 'right', 1);
        //engine.renderer.renderPacDots([new PacDot(new Position(110, 110)), new PacDot(new Position(120, 120)), new PacDot(new Position(140, 140),true)]);
        engine.renderer.renderLevel(level, dots);

        console.log(obj.position);
        console.log('');
        console.log('');
        console.log(obj.position);
        console.log('');
        console.log('');
        engine.renderer.renderPacDots(dots);
        engine.renderer.renderPacMan(player);
        engine.renderer.renderGhost(obj);

        function movingPacMan() {
            paperPacMan.clear();
            engine.renderer.renderPacMan(player);
            player.move();

        }
        setInterval(movingPacMan, 10);

        // while(true) for ghost AI tests after that will be made to function and added to engine
        function getRandomOtherDirection(posssibleDirs) {
            var randomDirection = posssibleDirs[Math.floor(Math.random() * posssibleDirs.length)];

            return randomDirection;
        }

        function posibleStep(nextX, nextY) {
            if (level[nextY][nextX]) {
                return false;
            }
            return true;
        }

        function checkLeftAndRight(obj, directions) {
            var result = directions;
            var step = 20;
            var nextX = obj.position.x;
            var nextY = obj.position.y;

            if (!level[nextY][nextX - step]) {
                result.push('left');
            }
            if (!level[nextY][nextX + step]) {
                result.push('right');
            }

            return result;
        }


        function checkUpAndDown(obj, directions) {
            var result = directions;
            var step = 20;
            var nextX = obj.position.x;
            var nextY = obj.position.y;

            if (!level[nextY - step][nextX]) {
                result.push('up');
            }
            if (!level[nextY + step][nextX]) {
                result.push('down');
            }

            return result;
        }

        function ghostAIMovements() {
            var step = 20;
            var direction = obj.direction;
            var nextX = obj.position.x;
            var nextY = obj.position.y;
            var possibleDirections = [];
            possibleDirections.push(direction);

            switch (direction) {
                case 'left':
                    nextX -= step;
                    possibleDirections = checkUpAndDown(obj, possibleDirections);
                    break;
                case 'up':
                    nextY -= step;
                    possibleDirections = checkLeftAndRight(obj, possibleDirections);
                    break;
                case 'right':
                    nextX += step;
                    possibleDirections = checkUpAndDown(obj, possibleDirections);
                    break;
                case 'down':
                    nextY += step;
                    possibleDirections = checkLeftAndRight(obj, possibleDirections);
                    break;
                default:
                    break;
            }

            console.log(possibleDirections);

            // On cross section
            var isNextPosible = posibleStep(nextX, nextY);
            if (!isNextPosible) {
                possibleDirections.shift();
            }

            console.log(possibleDirections);
            obj.direction = getRandomOtherDirection(possibleDirections);
            console.log(obj.direction);
            obj.move();

            console.log('ghostAIMovements');
            setTimeout(ghostAIMovements, 500);
        }
        ghostAIMovements();

        //engine.renderer.erasePacDot(new PacDot(new Position(120, 120)));
        //engine.renderer.erasePacDot(new PacDot(new Position(140, 140), true));
    </script>
</body>
</html>
